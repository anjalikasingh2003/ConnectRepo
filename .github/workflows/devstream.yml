name: DevStreamAI CI

on:
  push:
    branches: ["master", "main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Add project root to PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          echo "Running tests..."
          pytest --maxfail=1

      - name: Send CI failure to DevStream AI
        if: ${{ steps.tests.outcome == 'failure' }}
        run: |
          echo "âŒ Tests failed â€” sending details to DevStream AI..."

          ERROR_LOG=$(pytest --maxfail=1 2>&1 || true)

          FILE_PATH=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep ".py" | head -n 1 || true)
          if [ -z "$FILE_PATH" ]; then
              FILE_PATH=$(echo "$ERROR_LOG" | grep -oP '(?<=File ")[^"]+\.py' | head -n 1)
          fi
          if [ -z "$FILE_PATH" ]; then
              FILE_PATH=$(echo "$ERROR_LOG" | grep -oP "src/[A-Za-z0-9_\/]+\.py" | head -n 1)
          fi
          if [ -z "$FILE_PATH" ]; then
              FILE_PATH=$(find . -type f -name "*.py" | head -n 1)
          fi

          echo "ðŸ“Œ Detected failing file: $FILE_PATH"

          CODE_CONTENT=$(sed ':a;N;$!ba;s/\n/\\n/g' "$FILE_PATH" | sed 's/"/\\"/g')
          ESCAPED_LOG=$(printf "%s" "$ERROR_LOG" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')

          curl -X POST "${{ secrets.DEVSTREAM_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"repo_owner\": \"${{ github.repository_owner }}\",
              \"repo_name\": \"${{ github.event.repository.name }}\",
              \"branch\": \"${GITHUB_REF_NAME}\",
              \"commit\": \"${GITHUB_SHA}\",
              \"log\": \"$ESCAPED_LOG\",
              \"file_path\": \"$FILE_PATH\",
              \"code\": \"$CODE_CONTENT\"
            }"

      - name: Success message
        if: ${{ steps.tests.outcome == 'success' }}
        run: echo "âœ” CI passed without errors."